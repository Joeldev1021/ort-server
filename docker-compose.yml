# Copyright (C) 2022 The ORT Project Authors (See <https://github.com/oss-review-toolkit/ort-server/blob/main/NOTICE>)
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     https://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
# SPDX-License-Identifier: Apache-2.0
# License-Filename: LICENSE

version: "3.9"
services:
  ort-server:
    build:
      context: .
      dockerfile: ./core/Dockerfile
    image: ort-server
    depends_on:
      postgres:
        condition: service_healthy
      keycloak:
        condition: service_healthy
    healthcheck:
      test: [ "CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:8080/api/v1/liveness" ]
      interval: 10s
      timeout: 5s
      retries: 5
    ports:
    - "8080:8080"
    environment:
      PORT: 8080
      DB_URL: "jdbc:postgresql://postgres:5432"
      DB_NAME: ort_server
      DB_SCHEMA: ort_server
      DB_USERNAME: postgres
      DB_PASSWORD: postgres
      DB_SSLMODE: disable
      JWT_URI: "http://keycloak:8080/realms/master/protocol/openid-connect/certs"

  postgres:
    image: postgres:14
    restart: unless-stopped
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U postgres']
      interval: 10s
      timeout: 5s
      retries: 5
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: ort_server
    ports:
    # Use port 5433 on the host to avoid a conflict with a running postgres instance on the host.
    - "5433:5432"
    volumes:
    - db:/var/lib/postgresql/data

  keycloak:
    image: quay.io/keycloak/keycloak:19.0.1
    restart: unless-stopped
    entrypoint: /opt/keycloak_init/init-keycloak.sh
    command:
    - "start-dev"
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl --fail http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 5
    environment:
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
      KC_DB: postgres
      KC_DB_USERNAME: postgres
      KC_DB_PASSWORD: postgres
      KC_DB_URL: "jdbc:postgresql://postgres:5432/ort_server"
      KC_HEALTH_ENABLED: "true"
    ports:
    - "8081:8080"
    volumes:
    - type: bind
      source: ./scripts/docker/keycloak/
      target: /opt/keycloak_init/

  analyzer-worker:
    image: ort-server-analyzer-worker
    depends_on:
      ort-server:
        condition: service_healthy
    network_mode: host
    environment:
      ORT_SERVER_URL: "http://localhost:8080"
      ORT_SERVER_USER: admin
      ORT_SERVER_PASSWORD: admin
      ORT_SERVER_AUTH_URL: "http://localhost:8081/realms/master/protocol/openid-connect/token"
      ORT_SERVER_CLIENT_ID: "ort-server"

volumes:
  db:
    driver: local
